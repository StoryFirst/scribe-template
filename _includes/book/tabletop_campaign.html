<article class="book-detail px-4 py-8">
  <header class="mb-8">
    <h1 class="text-4xl font-bold mb-4">{{ page.name }}</h1>
  </header>

  {% if page.cast and page.cast.size > 0 %}
  <section class="cast mb-12">
    <h2 class="text-2xl font-bold mb-6">Cast</h2>

    {% assign cast_by_role = page.cast | group_by: "role" %}
    {% assign role_order = "main_ensamble,protagonist,supporting_character,antagonist" | split: "," %}

    {% for role_name in role_order %}
      {% assign role_group = cast_by_role | where: "name", role_name | first %}
      {% if role_group %}
        <div class="mb-8">
          <h3 class="text-lg font-semibold mb-4 text-gray-800">{{ role_name | replace: "_", " " | capitalize }}</h3>
          <div class="space-y-4">
            {% for cast_member in role_group.items %}
              {% assign character = site.characters | where: "scribe_id", cast_member.id | first %}
              {% if character %}
                <div class="border-l-4 {% if cast_member.role == 'main_ensamble' or cast_member.role == 'protagonist' %}border-green-500{% elsif cast_member.role == 'supporting_character' %}border-blue-500{% elsif cast_member.role == 'antagonist' %}border-red-500{% else %}border-gray-500{% endif %}">
                  <div class="flex items-start gap-4 pl-4">
                    <!-- Character Image -->
                    {% if character.image_url %}
                    <div class="flex-shrink-0">
                      <a href="{{ character.url | relative_url }}" class="block">
                        <img src="{{ character.image_url }}" alt="{{ character.name }}" class="w-20 h-20 rounded-lg object-cover hover:opacity-80 transition-opacity">
                      </a>
                    </div>
                    {% endif %}

                    <!-- Character Info -->
                    <div class="flex-1 min-w-0">
                      <div class="flex items-start justify-between gap-2">
                        <div class="flex-1">
                          <h4 class="font-semibold text-gray-900">
                            <a href="{{ character.url | relative_url }}" class="hover:text-blue-600">{{ character.name }}</a>
                          </h4>
                          {% if character.caption %}
                          <p class="text-sm text-gray-500 mb-1">{{ character.caption }}</p>
                          {% endif %}
                        </div>
                        {% if cast_member.role %}
                        {% assign badge_color = "bg-gray-100 text-gray-800" %}
                        {% if cast_member.role == "main_ensamble" or cast_member.role == "protagonist" %}
                          {% assign badge_color = "bg-green-100 text-green-800" %}
                        {% elsif cast_member.role == "supporting_character" %}
                          {% assign badge_color = "bg-blue-100 text-blue-800" %}
                        {% elsif cast_member.role == "antagonist" %}
                          {% assign badge_color = "bg-red-100 text-red-800" %}
                        {% endif %}
                        <span class="flex-shrink-0 px-3 py-1 text-xs font-medium rounded-full whitespace-nowrap {{ badge_color }}">
                          {{ cast_member.role | replace: "_", " " | capitalize }}
                        </span>
                        {% endif %}
                      </div>
                      {% if cast_member.description %}
                      <div class="text-gray-700 mt-2 text-sm prose prose-sm max-w-none"><div class="content">{{ cast_member.description | markdownify }}</div></div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      {% endif %}
    {% endfor %}

    {% comment %} Handle any roles not in the predefined order {% endcomment %}
    {% for role_group in cast_by_role %}
      {% unless role_order contains role_group.name %}
        <div class="mb-8">
          <h3 class="text-lg font-semibold mb-4 text-gray-800">{{ role_group.name | replace: "_", " " | capitalize }}</h3>
          <div class="space-y-4">
            {% for cast_member in role_group.items %}
              {% assign character = site.characters | where: "scribe_id", cast_member.id | first %}
              {% if character %}
                <div class="border-l-4 border-gray-500">
                  <div class="flex items-start gap-4 pl-4">
                    <!-- Character Image -->
                    {% if character.image_url %}
                    <div class="flex-shrink-0">
                      <a href="{{ character.url | relative_url }}" class="block">
                        <img src="{{ character.image_url }}" alt="{{ character.name }}" class="w-20 h-20 rounded-lg object-cover hover:opacity-80 transition-opacity">
                      </a>
                    </div>
                    {% endif %}

                    <!-- Character Info -->
                    <div class="flex-1 min-w-0">
                      <div class="flex items-start justify-between gap-2">
                        <div class="flex-1">
                          <h4 class="font-semibold text-gray-900">
                            <a href="{{ character.url | relative_url }}" class="hover:text-blue-600">{{ character.name }}</a>
                          </h4>
                          {% if character.caption %}
                          <p class="text-sm text-gray-500 mb-1">{{ character.caption }}</p>
                          {% endif %}
                        </div>
                        {% if cast_member.role %}
                        <span class="flex-shrink-0 px-3 py-1 text-xs font-medium rounded-full whitespace-nowrap bg-gray-100 text-gray-800">
                          {{ cast_member.role | replace: "_", " " | capitalize }}
                        </span>
                        {% endif %}
                      </div>
                      {% if character.description %}
                      <div class="text-gray-700 mt-2 text-sm prose prose-sm max-w-none"><div class="content">{{ character.description | markdownify }}</div></div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      {% endunless %}
    {% endfor %}
  </section>
  {% endif %}

  <section class="chapters mb-12">
    <h2 class="text-2xl font-bold mb-6">Chapters</h2>

    {% assign book_chapters = site.chapters | where: "book_id", page.scribe_id | sort: "number" %}

    {% if book_chapters.size > 0 %}
      <div class="space-y-4">
        {% for chapter in book_chapters %}
          <div class="border-l-4 border-blue-500">
            <div class="flex items-start gap-4 pl-4">
              <!-- Chapter Image -->
              {% if chapter.image_url %}
              <div class="flex-shrink-0">
                <a href="{{ chapter.url | relative_url }}" class="block">
                  <img src="{{ chapter.image_url }}" alt="{{ chapter.name }}" class="w-20 h-20 rounded-lg object-cover hover:opacity-80 transition-opacity">
                </a>
              </div>
              {% endif %}

              <!-- Chapter Info -->
              <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-2">
                  <div class="flex-1">
                    <h3 class="font-semibold text-gray-900">
                      <a href="{{ chapter.url | relative_url }}" class="hover:text-blue-600">{{ chapter.name }}</a>
                    </h3>
                    {% if chapter.caption %}
                    <p class="text-sm text-gray-500 mb-1">{{ chapter.caption }}</p>
                    {% endif %}
                  </div>
                  <span class="flex-shrink-0 px-3 py-1 text-xs font-medium rounded-full whitespace-nowrap bg-blue-100 text-blue-800">
                    Chapter {{ chapter.number }}
                  </span>
                </div>
                {% if chapter.description %}
                <div class="text-gray-700 mt-2 text-sm prose prose-sm max-w-none"><div class="content">{{ chapter.description | markdownify }}</div></div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-gray-500 italic">No chapters found for this book.</p>
    {% endif %}
  </section>

  {% if page.description %}
    <section class="book-description mb-12">
      <h2 class="text-2xl font-bold mb-6">Description</h2>
      <div class="text-lg text-gray-700 prose max-w-none">
        <div class="content">{{ page.description | markdownify }}</div>
      </div>
    </section>
  {% endif %}

  {% if page.content and page.content != "" %}
    <section class="book-content prose max-w-none mb-12">
      <h2 class="text-2xl font-bold mb-6">Content</h2>
      {{ content }}
    </section>
  {% endif %}
</article>


